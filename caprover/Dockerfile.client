# Building the Wasp app
FROM --platform=linux/amd64 node:18 AS wasp-build

ARG SERVER_APP_URL

ENV SERVER_APP_URL=$SERVER_APP_URL

RUN curl -sSL https://get.wasp-lang.dev/installer.sh | sh -s -- -v 0.11.7

ENV PATH="/root/.local/bin:${PATH}"

WORKDIR /app

COPY . /app

RUN wasp build

# Building the client

WORKDIR /app/.wasp/build/web-app

RUN REACT_APP_API_URL=$SERVER_APP_URL npm run build

# Serving the client

FROM pierrezemb/gostatic
CMD [ "-fallback", "index.html", "-enable-logging"]
COPY --from=wasp-build /app/.wasp/build/web-app/build /srv/http
